<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realidade Aumentada com Rastreamento Perfeito de Mãos</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #cameraFeed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Espelhar a imagem da câmera */
        }
        
        #threeCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            transition: opacity 0.5s;
        }
        
        #loading h1 {
            margin-bottom: 20px;
            font-size: 2rem;
            color: #4CAF50;
        }
        
        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 8px solid #4CAF50;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            z-index: 20;
            font-size: 14px;
        }
        
        #instructions h2 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .status.success {
            color: #4CAF50;
            border-left: 3px solid #4CAF50;
        }
        
        .status.error {
            color: #f44336;
            border-left: 3px solid #f44336;
        }
        
        #debugInfo {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 20;
            max-width: 250px;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="cameraFeed" playsinline></video>
        <canvas id="threeCanvas"></canvas>
        
        <div id="loading">
            <div class="spinner"></div>
            <h1>Carregando Aplicação</h1>
            <div id="loadingStatus">Inicializando...</div>
        </div>
        
        <div id="instructions">
            <h2>Instruções Melhoradas:</h2>
            <p>1. Mantenha sua mão aberta em frente à câmera</p>
            <p>2. O objeto 3D seguirá perfeitamente sua mão</p>
            <p>3. O objeto mantém tamanho e orientação consistentes</p>
            <p>4. Mova sua mão para ver o rastreamento preciso</p>
            <p>5. O objeto aparece exatamente sobre sua palma</p>
        </div>
        
        <div id="debugInfo">
            <strong>Debug Info:</strong><br>
            <span id="handStatus">Mão: Não detectada</span><br>
            <span id="positionInfo">Posição: --</span><br>
            <span id="confidenceInfo">Confiança: --</span>
        </div>
    </div>

    <!-- Bibliotecas necessárias -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- Arquivo do objeto 3D -->
    <script src="objeto3d.js"></script>
    
    <script>
        // Variáveis globais
        let scene, camera, renderer, objeto3D;
        let handDetected = false;
        let handPosition = { x: 0, y: 0, z: 0 };
        let handRotation = { x: 0, y: 0, z: 0 };
        let smoothingFactor = 0.8; // Para suavizar o movimento
        let videoWidth = 1280;
        let videoHeight = 720;

        // Elementos DOM
        const videoElement = document.getElementById('cameraFeed');
        const canvasElement = document.getElementById('threeCanvas');
        const loadingElement = document.getElementById('loading');
        const loadingStatus = document.getElementById('loadingStatus');
        const handStatus = document.getElementById('handStatus');
        const positionInfo = document.getElementById('positionInfo');
        const confidenceInfo = document.getElementById('confidenceInfo');

        // Atualizar status de carregamento
        function updateLoadingStatus(message, isError = false) {
            loadingStatus.textContent = message;
            loadingStatus.className = 'status ' + (isError ? 'error' : 'success');
        }

        // Converter coordenadas da mão para coordenadas 3D
        function convertHandToWorld(handX, handY, handZ) {
            // Inverter X devido ao espelhamento da câmera
            const worldX = (0.5 - handX) * 8; // Ajustar escala para melhor posicionamento
            const worldY = (0.5 - handY) * 6; // Ajustar escala vertical
            const worldZ = handZ * -10; // Profundidade (negativo para ficar na frente)
            
            return { x: worldX, y: worldY, z: worldZ };
        }

        // Calcular orientação da mão
        function calculateHandOrientation(landmarks) {
            // Usar pontos específicos para calcular orientação
            const wrist = landmarks[0];
            const middleFingerMCP = landmarks[9];
            const indexFingerMCP = landmarks[5];
            const pinkyMCP = landmarks[17];
            
            // Vetor da palma (do pulso ao dedo médio)
            const palmVector = {
                x: middleFingerMCP.x - wrist.x,
                y: middleFingerMCP.y - wrist.y,
                z: middleFingerMCP.z - wrist.z
            };
            
            // Vetor lateral (do mindinho ao indicador)
            const sideVector = {
                x: indexFingerMCP.x - pinkyMCP.x,
                y: indexFingerMCP.y - pinkyMCP.y,
                z: indexFingerMCP.z - pinkyMCP.z
            };
            
            // Calcular ângulos de rotação
            const rotX = Math.atan2(palmVector.y, palmVector.z);
            const rotY = Math.atan2(palmVector.x, palmVector.z);
            const rotZ = Math.atan2(sideVector.y, sideVector.x);
            
            return { x: rotX, y: rotY, z: rotZ };
        }

        // Inicializar Three.js
        function initThreeJS() {
            // Criar cena
            scene = new THREE.Scene();
            scene.background = null; // Fundo transparente
            
            // Adicionar luzes melhoradas
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            const pointLight = new THREE.PointLight(0x4CAF50, 0.5, 100);
            pointLight.position.set(0, 0, 10);
            scene.add(pointLight);
            
            // Criar câmera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);
            
            // Criar renderizador
            renderer = new THREE.WebGLRenderer({
                canvas: canvasElement,
                alpha: true, // Fundo transparente
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Criar o objeto 3D
            objeto3D = criarObjeto3D();
            objeto3D.scale.set(0.5, 0.5, 0.5); // Tamanho fixo e consistente
            scene.add(objeto3D);
            
            // Configurar eventos de redimensionamento
            window.addEventListener('resize', onWindowResize);
            
            updateLoadingStatus("Three.js inicializado com sucesso!");
        }

        // Manipular redimensionamento da janela
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Configurar MediaPipe Hands
        function setupMediaPipe() {
            const hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.7, // Aumentar confiança
                minTrackingConfidence: 0.7
            });
            
            hands.onResults(onHandResults);
            
            // Iniciar a câmera
            const cameraInstance = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: videoWidth,
                height: videoHeight
            });
            
            cameraInstance.start()
                .then(() => {
                    updateLoadingStatus("Câmera iniciada com sucesso!");
                })
                .catch(error => {
                    updateLoadingStatus("Erro ao iniciar a câmera: " + error, true);
                });
            
            return hands;
        }

        // Processar resultados do MediaPipe Hands
        function onHandResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                handDetected = true;
                
                // Usar o centro da palma (landmark 9 - base do dedo médio)
                const palmCenter = landmarks[9];
                
                // Converter para coordenadas do mundo 3D
                const worldPos = convertHandToWorld(palmCenter.x, palmCenter.y, palmCenter.z);
                
                // Aplicar suavização para movimento mais fluido
                handPosition.x = handPosition.x * smoothingFactor + worldPos.x * (1 - smoothingFactor);
                handPosition.y = handPosition.y * smoothingFactor + worldPos.y * (1 - smoothingFactor);
                handPosition.z = handPosition.z * smoothingFactor + worldPos.z * (1 - smoothingFactor);
                
                // Calcular orientação da mão
                const orientation = calculateHandOrientation(landmarks);
                handRotation.x = handRotation.x * smoothingFactor + orientation.x * (1 - smoothingFactor);
                handRotation.y = handRotation.y * smoothingFactor + orientation.y * (1 - smoothingFactor);
                handRotation.z = handRotation.z * smoothingFactor + orientation.z * (1 - smoothingFactor);
                
                // Atualizar informações de debug
                handStatus.textContent = "Mão: Detectada";
                positionInfo.textContent = `Posição: (${handPosition.x.toFixed(2)}, ${handPosition.y.toFixed(2)}, ${handPosition.z.toFixed(2)})`;
                confidenceInfo.textContent = `Confiança: ${(results.multiHandedness[0].score * 100).toFixed(1)}%`;
                
            } else {
                handDetected = false;
                handStatus.textContent = "Mão: Não detectada";
                positionInfo.textContent = "Posição: --";
                confidenceInfo.textContent = "Confiança: --";
            }
        }

        // Animação
        function animate() {
            requestAnimationFrame(animate);
            
            if (handDetected && objeto3D) {
                // Posicionar o objeto exatamente na posição da mão
                objeto3D.position.set(handPosition.x, handPosition.y, handPosition.z);
                
                // Aplicar rotação baseada na orientação da mão (opcional)
                // objeto3D.rotation.set(handRotation.x, handRotation.y, handRotation.z);
                
                // Manter o objeto visível
                objeto3D.visible = true;
                
                // Executar animação interna do objeto
                if (objeto3D.userData.animate) {
                    objeto3D.userData.animate();
                }
            } else {
                // Esconder o objeto quando a mão não for detectada
                if (objeto3D) {
                    objeto3D.visible = false;
                }
            }
            
            renderer.render(scene, camera);
        }

        // Inicializar a aplicação
        async function initApp() {
            try {
                updateLoadingStatus("Inicializando Three.js...");
                initThreeJS();
                
                updateLoadingStatus("Configurando MediaPipe Hands...");
                setupMediaPipe();
                
                updateLoadingStatus("Iniciando animação...");
                animate();
                
                // Esconder tela de carregamento após 3 segundos
                setTimeout(() => {
                    loadingElement.style.opacity = '0';
                    setTimeout(() => {
                        loadingElement.style.display = 'none';
                    }, 500);
                }, 3000);
            } catch (error) {
                updateLoadingStatus("Erro na inicialização: " + error, true);
            }
        }

        // Iniciar quando o documento estiver carregado
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

