<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Labirinto El√©trico AR - MOBILE OTIMIZADO</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Nunito:wght@400;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #4C97FF, #9966FF, #FF6680);
            overflow: hidden;
            color: white;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #input_video {
            display: none;
        }

        #output_canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            border-radius: 0;
            object-fit: cover;
        }

        #three_canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            border-radius: 0;
            transform: scaleX(-1);
        }

        /* LAYOUT MOBILE RESPONSIVO */
        #game-ui {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            font-size: 14px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        @media (min-width: 768px) {
            #game-ui {
                top: 20px;
                left: 20px;
                font-size: 20px;
            }
        }

        #game-ui div {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #FF6680, #FF9F40);
            border-radius: 15px;
            border: 2px solid #FFFFFF;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-family: 'Fredoka One', cursive;
            font-size: 12px;
        }

        @media (min-width: 768px) {
            #game-ui div {
                margin-bottom: 15px;
                padding: 15px 20px;
                border-radius: 25px;
                border: 4px solid #FFFFFF;
                font-size: 16px;
            }
        }

        #victory-screen, #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4C97FF, #9966FF);
            color: white;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            z-index: 200;
            border: 3px solid #FFBF00;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            font-family: 'Fredoka One', cursive;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            #victory-screen, #game-over {
                padding: 50px;
                border-radius: 30px;
                border: 6px solid #FFBF00;
                max-width: 500px;
            }
        }

        #victory-screen h2, #game-over h2 {
            font-size: 2em;
            margin-bottom: 15px;
            color: #FFBF00;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }

        @media (min-width: 768px) {
            #victory-screen h2, #game-over h2 {
                font-size: 3em;
                margin-bottom: 25px;
            }
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            font-family: 'Fredoka One', cursive;
            font-weight: 400;
            background: linear-gradient(135deg, #40BF4A, #0FBD8C);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 2px solid #FFFFFF;
            touch-action: manipulation;
        }

        @media (min-width: 768px) {
            button {
                padding: 20px 40px;
                font-size: 22px;
                border-radius: 25px;
                margin: 15px;
                border: 3px solid #FFFFFF;
            }
        }

        button:hover, button:active {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
            background: linear-gradient(135deg, #0FBD8C, #40BF4A);
        }

        .hidden {
            display: none;
        }

        .spark-effect {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #FFBF00, #FF6680, #FF3355);
            border-radius: 50%;
            animation: spark 1s ease-out forwards;
            z-index: 50;
            pointer-events: none;
            box-shadow: 0 0 15px #FFBF00;
        }

        @media (min-width: 768px) {
            .spark-effect {
                width: 30px;
                height: 30px;
                box-shadow: 0 0 20px #FFBF00;
            }
        }

        @keyframes spark {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(4) rotate(360deg);
                opacity: 0;
            }
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 300;
            text-align: center;
            background: linear-gradient(135deg, #4C97FF, #9966FF);
            padding: 30px;
            border-radius: 20px;
            border: 3px solid #FFBF00;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            font-family: 'Fredoka One', cursive;
            color: white;
            max-width: 90vw;
        }

        @media (min-width: 768px) {
            #loading {
                padding: 40px;
                border-radius: 25px;
                border: 4px solid #FFBF00;
            }
        }

        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #FFBF00;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
            box-shadow: 0 0 15px rgba(255,191,0,0.5);
        }

        @media (min-width: 768px) {
            .loading-spinner {
                border: 6px solid rgba(255,255,255,0.3);
                border-top: 6px solid #FFBF00;
                width: 60px;
                height: 60px;
                margin: 0 auto 20px;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .electric-trail {
            position: absolute;
            width: 6px;
            height: 6px;
            background: linear-gradient(45deg, #4C97FF, #40BF4A);
            border-radius: 50%;
            animation: trail 0.6s ease-out forwards;
            z-index: 5;
            pointer-events: none;
            box-shadow: 0 0 10px #4C97FF;
        }

        @media (min-width: 768px) {
            .electric-trail {
                width: 8px;
                height: 8px;
                box-shadow: 0 0 15px #4C97FF;
            }
        }

        @keyframes trail {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.2);
            }
        }

        .floating-shapes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            display: none; /* OCULTAR NO MOBILE PARA PERFORMANCE */
        }

        @media (min-width: 768px) {
            .floating-shapes {
                display: block;
            }
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            animation: float 4s ease-in-out infinite;
            opacity: 0.1;
        }

        .shape:nth-child(1) { background: #FF6680; width: 40px; height: 40px; top: 10%; left: 10%; animation-delay: 0s; }
        .shape:nth-child(2) { background: #FFBF00; width: 30px; height: 30px; top: 20%; right: 15%; animation-delay: 1s; }
        .shape:nth-child(3) { background: #40BF4A; width: 50px; height: 50px; bottom: 20%; left: 20%; animation-delay: 2s; }
        .shape:nth-child(4) { background: #4C97FF; width: 35px; height: 35px; bottom: 30%; right: 10%; animation-delay: 3s; }

        @media (min-width: 768px) {
            .shape:nth-child(1) { width: 60px; height: 60px; }
            .shape:nth-child(2) { width: 40px; height: 40px; }
            .shape:nth-child(3) { width: 80px; height: 80px; }
            .shape:nth-child(4) { width: 50px; height: 50px; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        #sound-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }

        @media (min-width: 768px) {
            #sound-controls {
                top: 20px;
                right: 20px;
            }
        }

        #mute-btn {
            padding: 8px 12px;
            font-size: 12px;
            background: linear-gradient(135deg, #FF6680, #FF9F40);
            border: 2px solid #FFFFFF;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-family: 'Fredoka One', cursive;
            touch-action: manipulation;
        }

        @media (min-width: 768px) {
            #mute-btn {
                padding: 10px 15px;
                font-size: 16px;
                border: 3px solid #FFFFFF;
                border-radius: 15px;
            }
        }

        #mute-btn:hover, #mute-btn:active {
            transform: scale(1.05);
        }

        /* ORIENTA√á√ÉO LANDSCAPE PARA MOBILE */
        @media screen and (orientation: portrait) and (max-width: 768px) {
            body::before {
                content: "üîÑ Gire o dispositivo para landscape para melhor experi√™ncia!";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                font-size: 18px;
                font-family: 'Fredoka One', cursive;
                z-index: 1000;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="input_video" autoplay muted playsinline></video>
        <canvas id="output_canvas"></canvas>
        <canvas id="three_canvas"></canvas>
        
        <!-- √ÅUDIOS DO JOGO -->
        <audio id="background-music" loop>
            <source src="fundo.mp3" type="audio/mpeg">
        </audio>
        <audio id="collision-sound">
            <source src="colisao.mp3" type="audio/mpeg">
        </audio>
        <audio id="victory-sound">
            <source src="vitoria.mp3" type="audio/mpeg">
        </audio>
        
        <div class="floating-shapes">
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
        
        <div id="sound-controls">
            <button id="mute-btn">üîä</button>
        </div>
        
        <div id="loading">
            <div class="loading-spinner"></div>
            <h2>üéÆ Carregando!</h2>
            <p>Preparando c√¢mera...</p>
            <p>Permita acesso!</p>
        </div>
        
        <div id="game-ui" class="hidden">
            <div id="score">‚ö° <span id="points">100</span></div>
            <div id="level">üéØ <span id="current-level">1</span></div>
            <div id="status">Aproxime o dedo!</div>
        </div>
        
        <div id="victory-screen" class="hidden">
            <h2>üèÜ Incr√≠vel!</h2>
            <p>Fase completa!</p>
            <p>Energia: <span id="final-points"></span></p>
            <button id="next-level">Pr√≥xima! üöÄ</button>
        </div>
        
        <div id="game-over" class="hidden">
            <h2>üí• Ops!</h2>
            <p>Energia acabou!</p>
            <button id="restart">Tentar! üîÑ</button>
        </div>
    </div>

    <script>
        // ===== CONFIGURA√á√ÉO DOS N√çVEIS - FASE 5 COM MAIS ESPA√áO =====
        const LEVELS = [
            {
                id: 1,
                name: "Primeira Aventura",
                maze: [
                    { x1: 0.1, y1: 0.1, x2: 0.9, y2: 0.15, color: 0xFF6680 },
                    { x1: 0.1, y1: 0.85, x2: 0.9, y2: 0.9, color: 0xFF6680 },
                    { x1: 0.1, y1: 0.1, x2: 0.15, y2: 0.9, color: 0xFF6680 },
                    { x1: 0.85, y1: 0.1, x2: 0.9, y2: 0.9, color: 0xFF6680 },
                    { x1: 0.4, y1: 0.15, x2: 0.45, y2: 0.6, color: 0x9966FF },
                ],
                startPoint: { x: 0.25, y: 0.5 },
                endPoint: { x: 0.75, y: 0.5 },
                tolerance: 0.015
            },
            {
                id: 2,
                name: "Desafio M√©dio",
                maze: [
                    { x1: 0.05, y1: 0.05, x2: 0.95, y2: 0.1, color: 0xFF6680 },
                    { x1: 0.05, y1: 0.9, x2: 0.95, y2: 0.95, color: 0xFF6680 },
                    { x1: 0.05, y1: 0.05, x2: 0.1, y2: 0.95, color: 0xFF6680 },
                    { x1: 0.9, y1: 0.05, x2: 0.95, y2: 0.95, color: 0xFF6680 },
                    { x1: 0.3, y1: 0.1, x2: 0.35, y2: 0.5, color: 0x9966FF },
                    { x1: 0.5, y1: 0.4, x2: 0.55, y2: 0.9, color: 0x4C97FF },
                    { x1: 0.65, y1: 0.1, x2: 0.7, y2: 0.6, color: 0x9966FF },
                ],
                startPoint: { x: 0.2, y: 0.3 },
                endPoint: { x: 0.8, y: 0.7 },
                tolerance: 0.012
            },
            {
                id: 3,
                name: "Labirinto Complexo",
                maze: [
                    { x1: 0.02, y1: 0.02, x2: 0.98, y2: 0.07, color: 0xFF6680 },
                    { x1: 0.02, y1: 0.93, x2: 0.98, y2: 0.98, color: 0xFF6680 },
                    { x1: 0.02, y1: 0.02, x2: 0.07, y2: 0.98, color: 0xFF6680 },
                    { x1: 0.93, y1: 0.02, x2: 0.98, y2: 0.98, color: 0xFF6680 },
                    { x1: 0.25, y1: 0.07, x2: 0.3, y2: 0.4, color: 0x9966FF },
                    { x1: 0.25, y1: 0.6, x2: 0.3, y2: 0.93, color: 0x9966FF },
                    { x1: 0.45, y1: 0.25, x2: 0.5, y2: 0.75, color: 0x4C97FF },
                    { x1: 0.65, y1: 0.07, x2: 0.7, y2: 0.5, color: 0x9966FF },
                    { x1: 0.65, y1: 0.7, x2: 0.7, y2: 0.93, color: 0x9966FF },
                    { x1: 0.15, y1: 0.5, x2: 0.4, y2: 0.55, color: 0x4C97FF },
                    { x1: 0.55, y1: 0.3, x2: 0.8, y2: 0.35, color: 0x4C97FF },
                ],
                startPoint: { x: 0.15, y: 0.2 },
                endPoint: { x: 0.85, y: 0.8 },
                tolerance: 0.010
            },
            {
                id: 4,
                name: "Desafio Avan√ßado",
                maze: [
                    // Bordas externas
                    { x1: 0.01, y1: 0.01, x2: 0.99, y2: 0.06, color: 0xFF6680 },
                    { x1: 0.01, y1: 0.94, x2: 0.99, y2: 0.99, color: 0xFF6680 },
                    { x1: 0.01, y1: 0.01, x2: 0.06, y2: 0.99, color: 0xFF6680 },
                    { x1: 0.94, y1: 0.01, x2: 0.99, y2: 0.99, color: 0xFF6680 },
                    // Obst√°culos internos - formato de cruz
                    { x1: 0.2, y1: 0.06, x2: 0.25, y2: 0.4, color: 0x9966FF },
                    { x1: 0.2, y1: 0.6, x2: 0.25, y2: 0.94, color: 0x9966FF },
                    { x1: 0.4, y1: 0.2, x2: 0.6, y2: 0.25, color: 0x4C97FF },
                    { x1: 0.4, y1: 0.75, x2: 0.6, y2: 0.8, color: 0x4C97FF },
                    { x1: 0.75, y1: 0.06, x2: 0.8, y2: 0.4, color: 0x9966FF },
                    { x1: 0.75, y1: 0.6, x2: 0.8, y2: 0.94, color: 0x9966FF },
                    // Obst√°culos centrais
                    { x1: 0.35, y1: 0.35, x2: 0.4, y2: 0.65, color: 0xFF9F40 },
                    { x1: 0.6, y1: 0.35, x2: 0.65, y2: 0.65, color: 0xFF9F40 },
                    { x1: 0.45, y1: 0.45, x2: 0.55, y2: 0.5, color: 0x40BF4A },
                ],
                startPoint: { x: 0.12, y: 0.15 },
                endPoint: { x: 0.88, y: 0.85 },
                tolerance: 0.008
            },
            {
                id: 5,
                name: "Mestre Supremo - Espiral",
                maze: [
                    // BORDAS EXTERNAS COM MAIS ESPA√áO PARA DETEC√á√ÉO
                    { x1: 0.08, y1: 0.08, x2: 0.92, y2: 0.12, color: 0xFF6680 },
                    { x1: 0.08, y1: 0.88, x2: 0.92, y2: 0.92, color: 0xFF6680 },
                    { x1: 0.08, y1: 0.08, x2: 0.12, y2: 0.92, color: 0xFF6680 },
                    { x1: 0.88, y1: 0.08, x2: 0.92, y2: 0.92, color: 0xFF6680 },
                    
                    // ESPIRAL COMPLEXO - CAMADA EXTERNA (MAIS ESPA√áADO)
                    { x1: 0.2, y1: 0.12, x2: 0.24, y2: 0.8, color: 0x9966FF },
                    { x1: 0.2, y1: 0.76, x2: 0.8, y2: 0.8, color: 0x9966FF },
                    { x1: 0.76, y1: 0.2, x2: 0.8, y2: 0.8, color: 0x9966FF },
                    { x1: 0.32, y1: 0.2, x2: 0.8, y2: 0.24, color: 0x9966FF },
                    
                    // ESPIRAL - CAMADA M√âDIA
                    { x1: 0.32, y1: 0.2, x2: 0.36, y2: 0.68, color: 0x4C97FF },
                    { x1: 0.32, y1: 0.64, x2: 0.68, y2: 0.68, color: 0x4C97FF },
                    { x1: 0.64, y1: 0.32, x2: 0.68, y2: 0.68, color: 0x4C97FF },
                    { x1: 0.44, y1: 0.32, x2: 0.68, y2: 0.36, color: 0x4C97FF },
                    
                    // ESPIRAL - CAMADA INTERNA (ONDE EST√Å O FINAL!)
                    { x1: 0.44, y1: 0.32, x2: 0.48, y2: 0.56, color: 0xFF9F40 },
                    { x1: 0.44, y1: 0.52, x2: 0.56, y2: 0.56, color: 0xFF9F40 },
                    
                    // OBST√ÅCULOS EXTRAS MAIS AFASTADOS DAS BORDAS
                    { x1: 0.15, y1: 0.4, x2: 0.17, y2: 0.6, color: 0x40BF4A },
                    { x1: 0.83, y1: 0.4, x2: 0.85, y2: 0.6, color: 0x40BF4A },
                    
                    // BARREIRAS PARA FOR√áAR O CAMINHO DO ESPIRAL
                    { x1: 0.52, y1: 0.36, x2: 0.56, y2: 0.48, color: 0xFF3355 },
                ],
                startPoint: { x: 0.15, y: 0.15 }, // MAIS AFASTADO DA BORDA
                endPoint: { x: 0.5, y: 0.44 }, // FINAL DENTRO DO ESPIRAL! üéØ
                tolerance: 0.008 // TOLER√ÇNCIA MAIOR PARA MOBILE
            }
        ];

        // DETECTAR SE √â MOBILE
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

        // ===== SISTEMA DE √ÅUDIO =====
        class AudioManager {
            constructor() {
                this.backgroundMusic = document.getElementById('background-music');
                this.collisionSound = document.getElementById('collision-sound');
                this.victorySound = document.getElementById('victory-sound');
                this.isMuted = false;
                
                // Configurar volumes menores para mobile
                const volume = isMobile ? 0.2 : 0.3;
                this.backgroundMusic.volume = volume;
                this.collisionSound.volume = isMobile ? 0.4 : 0.6;
                this.victorySound.volume = isMobile ? 0.05 : 0.1;
                
                this.setupMuteButton();
            }
            
            setupMuteButton() {
                const muteBtn = document.getElementById('mute-btn');
                muteBtn.addEventListener('click', () => {
                    this.toggleMute();
                });
            }
            
            toggleMute() {
                this.isMuted = !this.isMuted;
                const muteBtn = document.getElementById('mute-btn');
                
                if (this.isMuted) {
                    this.backgroundMusic.pause();
                    muteBtn.textContent = 'üîá';
                } else {
                    this.playBackgroundMusic();
                    muteBtn.textContent = 'üîä';
                }
            }
            
            playBackgroundMusic() {
                if (!this.isMuted) {
                    this.backgroundMusic.play().catch(e => {
                        console.log('Erro ao tocar m√∫sica de fundo:', e);
                    });
                }
            }
            
            playCollisionSound() {
                if (!this.isMuted) {
                    this.collisionSound.currentTime = 0;
                    this.collisionSound.play().catch(e => {
                        console.log('Erro ao tocar som de colis√£o:', e);
                    });
                }
            }
            
            playVictorySound() {
                if (!this.isMuted) {
                    this.victorySound.currentTime = 0;
                    this.victorySound.play().catch(e => {
                        console.log('Erro ao tocar som de vit√≥ria:', e);
                    });
                }
            }
            
            stopBackgroundMusic() {
                this.backgroundMusic.pause();
            }
        }

        // ===== CLASSE PRINCIPAL DO JOGO - OTIMIZADA PARA MOBILE =====
        class LabirintoEletrico {
            constructor() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0.1, 1000);
                this.camera.position.z = 1;

                const canvas = document.getElementById('three_canvas');
                this.renderer = new THREE.WebGLRenderer({ 
                    alpha: true,
                    canvas: canvas,
                    antialias: !isMobile, // DESABILITAR ANTIALIAS NO MOBILE
                    powerPreference: isMobile ? "low-power" : "high-performance"
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setClearColor(0x000000, 0);

                // VARI√ÅVEIS DO JOGO
                this.gameObject = null;
                this.endPoint = null;
                this.walls = [];
                this.currentLevel = 1;
                this.points = 100;
                this.gameState = 'waiting';
                this.objectGrabbed = false;
                this.handPosition = { x: 0.5, y: 0.5 };
                this.lastCollisionTime = 0;
                this.collisionCooldown = isMobile ? 400 : 300; // COOLDOWN MAIOR NO MOBILE
                this.isShaking = false;
                
                // SISTEMA DE √ÅUDIO
                this.audioManager = new AudioManager();
                
                this.loadLevel(this.currentLevel);
            }

            loadLevel(levelId) {
                const level = LEVELS.find(l => l.id === levelId);
                if (!level) return;

                // RESETAR TUDO
                this.currentLevel = levelId;
                this.points = 100;
                this.gameState = 'waiting';
                this.objectGrabbed = false;
                this.isShaking = false;

                // LIMPAR CENA COMPLETAMENTE
                this.clearScene();

                // CRIAR APENAS 1 OBJETO - A ESFERA DO JOGO
                this.createGameObject(level.startPoint);

                // CRIAR PAREDES COM F√çSICA PRECISA
                this.createMazeWalls(level.maze);
                
                // CRIAR PONTO FINAL
                this.createEndPoint(level.endPoint);

                // ATUALIZAR UI
                document.getElementById('current-level').textContent = levelId;
                document.getElementById('points').textContent = this.points;
                document.getElementById('status').textContent = isMobile ? 'Aproxime!' : 'Aproxime o dedo!';
                
                // TOCAR M√öSICA DE FUNDO
                this.audioManager.playBackgroundMusic();
            }

            clearScene() {
                // REMOVE TODOS OS OBJETOS DA CENA
                while(this.scene.children.length > 0) {
                    const child = this.scene.children[0];
                    this.scene.remove(child);
                    if (child.geometry) child.geometry.dispose();
                    if (child.material) child.material.dispose();
                }
                
                // RESETAR ARRAYS
                this.walls = [];
                this.gameObject = null;
                this.endPoint = null;
            }

            createGameObject(startPoint) {
                // ESFERA MAIOR NO MOBILE PARA MELHOR VISIBILIDADE
                const size = isMobile ? 0.035 : 0.025;
                const geometry = new THREE.SphereGeometry(size, isMobile ? 16 : 32, isMobile ? 16 : 32);
                const material = new THREE.MeshBasicMaterial({ 
                    color: 0x40BF4A, // Verde
                    transparent: false,
                    opacity: 1.0
                });
                
                this.gameObject = new THREE.Mesh(geometry, material);
                this.gameObject.position.set(
                    (startPoint.x - 0.5) * 2,
                    -(startPoint.y - 0.5) * 2,
                    0
                );
                
                this.scene.add(this.gameObject);
            }

            createMazeWalls(maze) {
                maze.forEach((wall) => {
                    const width = Math.abs(wall.x2 - wall.x1) * 2;
                    const height = Math.abs(wall.y2 - wall.y1) * 2;
                    
                    const geometry = new THREE.PlaneGeometry(
                        Math.max(width, 0.02),
                        Math.max(height, 0.02)
                    );
                    
                    const material = new THREE.MeshBasicMaterial({ 
                        color: wall.color || 0xFF6680,
                        transparent: true,
                        opacity: 0.9
                    });
                    
                    const wallMesh = new THREE.Mesh(geometry, material);
                    wallMesh.position.set(
                        ((wall.x1 + wall.x2) / 2 - 0.5) * 2,
                        -((wall.y1 + wall.y2) / 2 - 0.5) * 2,
                        -0.01
                    );
                    
                    // Borda branca MAIS FINA NO MOBILE
                    if (!isMobile) { // S√ì ADICIONAR BORDA NO DESKTOP
                        const borderGeometry = new THREE.EdgesGeometry(geometry);
                        const borderMaterial = new THREE.LineBasicMaterial({ 
                            color: 0xFFFFFF,
                            linewidth: 1
                        });
                        const border = new THREE.LineSegments(borderGeometry, borderMaterial);
                        wallMesh.add(border);
                    }
                    
                    wallMesh.userData = { type: 'wall', wall: wall };
                    this.scene.add(wallMesh);
                    this.walls.push(wallMesh);
                });
            }

            createEndPoint(endPoint) {
                // PORTAL MAIOR NO MOBILE PARA MELHOR VISIBILIDADE
                const innerSize = isMobile ? 0.04 : (this.currentLevel === 5 ? 0.025 : 0.035);
                const outerSize = isMobile ? 0.08 : (this.currentLevel === 5 ? 0.05 : 0.07);
                
                const geometry = new THREE.RingGeometry(innerSize, outerSize, isMobile ? 16 : 32);
                const material = new THREE.MeshBasicMaterial({ 
                    color: 0xFFBF00, // Dourado
                    transparent: true,
                    opacity: 0.95
                });
                
                this.endPoint = new THREE.Mesh(geometry, material);
                this.endPoint.position.set(
                    (endPoint.x - 0.5) * 2,
                    -(endPoint.y - 0.5) * 2,
                    -0.005
                );
                
                this.scene.add(this.endPoint);
            }

            updateHandPosition(x, y) {
                this.handPosition = { x, y };

                // CRIAR RASTRO INVERTIDO NO EIXO X PARA FICAR NA BOLINHA
                if (!isMobile || Math.random() > 0.7) { // REDUZIR RASTROS NO MOBILE
                    this.createElectricTrail(x, y);
                }

                // L√ìGICA DO JOGO
                if (!this.objectGrabbed && this.gameState === 'waiting') {
                    // VERIFICAR SE PODE PEGAR O OBJETO - TOLER√ÇNCIA MAIOR NO MOBILE
                    const level = LEVELS.find(l => l.id === this.currentLevel);
                    const grabTolerance = isMobile ? 0.08 : 0.05;
                    const distance = Math.sqrt(
                        Math.pow(x - level.startPoint.x, 2) + 
                        Math.pow(y - level.startPoint.y, 2)
                    );

                    if (distance < grabTolerance) {
                        this.grabObject();
                    }
                }

                if (this.objectGrabbed && this.gameState === 'playing') {
                    // MOVER O OBJETO PARA A POSI√á√ÉO DA M√ÉO
                    if (this.gameObject && !this.isShaking) {
                        this.gameObject.position.set(
                            (x - 0.5) * 2,
                            -(y - 0.5) * 2,
                            0
                        );
                    }

                    // VERIFICAR COLIS√ïES COM F√çSICA PRECISA
                    this.checkCollisions();
                    this.checkVictory();
                }
            }

            createElectricTrail(x, y) {
                const trail = document.createElement('div');
                trail.className = 'electric-trail';
                // INVERTER EIXO X PARA FICAR NA BOLINHA AZUL
                trail.style.left = ((1 - x) * window.innerWidth) + 'px';
                trail.style.top = (y * window.innerHeight) + 'px';
                document.body.appendChild(trail);
                
                setTimeout(() => {
                    if (document.body.contains(trail)) {
                        document.body.removeChild(trail);
                    }
                }, isMobile ? 400 : 600);
            }

            grabObject() {
                this.objectGrabbed = true;
                this.gameState = 'playing';
                document.getElementById('status').textContent = isMobile ? 'Ao portal!' : 'Leve at√© o portal dourado!';
                
                // MUDAR COR DO OBJETO
                if (this.gameObject) {
                    this.gameObject.material.color.setHex(0x4C97FF); // Azul
                }
            }

            checkCollisions() {
                const currentTime = Date.now();
                if (currentTime - this.lastCollisionTime < this.collisionCooldown) return;

                const level = LEVELS.find(l => l.id === this.currentLevel);
                
                // USAR A POSI√á√ÉO DA M√ÉO PARA VERIFICAR COLIS√ÉO
                const objPos = { 
                    x: this.handPosition.x,
                    y: this.handPosition.y
                };

                for (let wall of level.maze) {
                    if (this.isPointNearWall(objPos, wall, level.tolerance)) {
                        this.handleCollision();
                        this.lastCollisionTime = currentTime;
                        break;
                    }
                }
            }

            isPointNearWall(point, wall, tolerance) {
                // F√çSICA MAIS PRECISA - S√ì DETECTA SE REALMENTE TOCAR
                const minX = Math.min(wall.x1, wall.x2) - tolerance;
                const maxX = Math.max(wall.x1, wall.x2) + tolerance;
                const minY = Math.min(wall.y1, wall.y2) - tolerance;
                const maxY = Math.max(wall.y1, wall.y2) + tolerance;

                return point.x >= minX && point.x <= maxX && 
                       point.y >= minY && point.y <= maxY;
            }

            handleCollision() {
                this.points -= (isMobile ? 6 : 8); // MENOS PUNI√á√ÉO NO MOBILE
                document.getElementById('points').textContent = this.points;
                
                // TOCAR SOM DE COLIS√ÉO
                this.audioManager.playCollisionSound();
                
                // EFEITO DE FA√çSCA INVERTIDO NO EIXO X PARA FICAR NA BOLINHA AZUL
                this.createSparkEffect();
                
                // EFEITO NO OBJETO QUE VOC√ä EST√Å SEGURANDO
                if (this.gameObject) {
                    this.gameObject.material.color.setHex(0xFF3355); // Vermelho
                    
                    // ATIVAR SHAKE MENOR
                    this.isShaking = true;
                    
                    // POSI√á√ÉO ATUAL DA BOLINHA
                    const currentHandPos = {
                        x: (this.handPosition.x - 0.5) * 2,
                        y: -(this.handPosition.y - 0.5) * 2,
                        z: 0
                    };
                    
                    // Shake effect MENOR E MAIS R√ÅPIDO
                    const shakeIntensity = isMobile ? 0.02 : 0.015;
                    const shakeFrames = isMobile ? 6 : 8;
                    
                    for (let i = 0; i < shakeFrames; i++) {
                        setTimeout(() => {
                            if (this.gameObject && this.isShaking) {
                                this.gameObject.position.set(
                                    currentHandPos.x + (Math.random() - 0.5) * shakeIntensity,
                                    currentHandPos.y + (Math.random() - 0.5) * shakeIntensity,
                                    currentHandPos.z
                                );
                            }
                        }, i * 25);
                    }
                    
                    setTimeout(() => {
                        if (this.gameObject) {
                            // VOLTAR PARA A POSI√á√ÉO DA M√ÉO
                            this.isShaking = false;
                            this.gameObject.position.set(
                                (this.handPosition.x - 0.5) * 2,
                                -(this.handPosition.y - 0.5) * 2,
                                0
                            );
                            this.gameObject.material.color.setHex(0x4C97FF);
                        }
                    }, isMobile ? 150 : 200);
                }

                if (this.points <= 0) {
                    this.gameOver();
                }
            }

            createSparkEffect() {
                // FA√çSCAS INVERTIDAS NO EIXO X PARA FICAREM NA BOLINHA AZUL
                const sparkCount = isMobile ? 2 : 3;
                for (let i = 0; i < sparkCount; i++) {
                    setTimeout(() => {
                        const spark = document.createElement('div');
                        spark.className = 'spark-effect';
                        // INVERTER EIXO X PARA FICAR NA BOLINHA AZUL
                        spark.style.left = ((1 - this.handPosition.x) * window.innerWidth - 10 + Math.random() * 20) + 'px';
                                                spark.style.top = (this.handPosition.y * window.innerHeight - 10 + Math.random() * 20) + 'px';
                        document.body.appendChild(spark);
                        
                        setTimeout(() => {
                            if (document.body.contains(spark)) {
                                document.body.removeChild(spark);
                            }
                        }, 1000);
                    }, i * (isMobile ? 80 : 60));
                }
            }

            checkVictory() {
                const level = LEVELS.find(l => l.id === this.currentLevel);
                // TOLER√ÇNCIA MAIOR NO MOBILE PARA VIT√ìRIA
                const distance = Math.sqrt(
                    Math.pow(this.handPosition.x - level.endPoint.x, 2) + 
                    Math.pow(this.handPosition.y - level.endPoint.y, 2)
                );

                // TOLER√ÇNCIA AJUSTADA PARA MOBILE E FASE 5
                let victoryTolerance = 0.04;
                if (isMobile) {
                    victoryTolerance = this.currentLevel === 5 ? 0.06 : 0.05;
                } else {
                    victoryTolerance = this.currentLevel === 5 ? 0.035 : 0.04;
                }
                
                if (distance < victoryTolerance) {
                    this.victory();
                }
            }

            victory() {
                this.gameState = 'victory';
                document.getElementById('final-points').textContent = this.points;
                document.getElementById('victory-screen').classList.remove('hidden');
                
                // TOCAR SOM DE VIT√ìRIA
                this.audioManager.playVictorySound();
                
                if (this.gameObject) {
                    this.gameObject.material.color.setHex(0xFFBF00); // Dourado
                }
                
                // ANIMA√á√ÉO DE VIT√ìRIA OTIMIZADA PARA MOBILE
                const animate = () => {
                    if (this.gameState === 'victory') {
                        if (this.gameObject) {
                            this.gameObject.rotation.y += isMobile ? 0.15 : 0.2;
                            this.gameObject.rotation.x += isMobile ? 0.1 : 0.15;
                        }
                        if (this.endPoint) {
                            this.endPoint.rotation.z += isMobile ? 0.08 : 0.1;
                        }
                        requestAnimationFrame(animate);
                    }
                };
                animate();
            }

            gameOver() {
                this.gameState = 'gameover';
                document.getElementById('game-over').classList.remove('hidden');
                
                // PARAR M√öSICA DE FUNDO
                this.audioManager.stopBackgroundMusic();
            }

            nextLevel() {
                document.getElementById('victory-screen').classList.add('hidden');
                
                if (this.currentLevel < LEVELS.length) {
                    this.loadLevel(this.currentLevel + 1);
                } else {
                    const message = isMobile ? 
                        'üéâ PARAB√âNS! Voc√™ √© um MESTRE SUPREMO! üéâ' :
                        'üéâ PARAB√âNS! Voc√™ √© um MESTRE SUPREMO do labirinto! Conseguiu chegar no centro do espiral! üéâ';
                    alert(message);
                    this.loadLevel(1);
                }
            }

            restart() {
                document.getElementById('game-over').classList.add('hidden');
                this.loadLevel(this.currentLevel);
            }

            render() {
                // ANIMA√á√ïES OTIMIZADAS PARA MOBILE
                if (this.gameObject && !this.isShaking) {
                    const rotationSpeed = isMobile ? 0.01 : 0.015;
                    this.gameObject.rotation.x += rotationSpeed;
                    this.gameObject.rotation.y += rotationSpeed * 1.3;
                }
                
                if (this.endPoint) {
                    this.endPoint.rotation.z += isMobile ? 0.02 : 0.03;
                }

                // ANIMA√á√ÉO DAS PAREDES REDUZIDA NO MOBILE
                if (!isMobile || Math.random() > 0.8) {
                    this.walls.forEach((wall, index) => {
                        const pulse = Math.sin(Date.now() * 0.002 + index * 0.5) * 0.05 + 0.9;
                        wall.material.opacity = pulse;
                    });
                }
                
                this.renderer.render(this.scene, this.camera);
            }
        }

        // ===== RASTREAMENTO DE M√ÉOS OTIMIZADO =====
        class HandTracker {
            constructor() {
                this.hands = null;
                this.camera = null;
                this.onResults = null;
            }

            async initialize(videoElement, canvasElement, onResultsCallback) {
                this.onResults = onResultsCallback;
                
                this.hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });

                // CONFIGURA√á√ïES OTIMIZADAS PARA MOBILE
                this.hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: isMobile ? 0 : 1, // MODELO MAIS SIMPLES NO MOBILE
                    minDetectionConfidence: isMobile ? 0.7 : 0.8,
                    minTrackingConfidence: isMobile ? 0.6 : 0.7
                });

                this.hands.onResults(this.onResults);

                this.camera = new Camera(videoElement, {
                    onFrame: async () => {
                        await this.hands.send({ image: videoElement });
                    },
                    // RESOLU√á√ÉO OTIMIZADA PARA MOBILE
                    width: isMobile ? 640 : 1280,
                    height: isMobile ? 480 : 720
                });

                await this.camera.start();
                return true;
            }

            getIndexFingerTip(landmarks) {
                if (!landmarks || landmarks.length === 0) return null;
                return landmarks[8];
            }
        }

        // ===== INICIALIZA√á√ÉO =====
        let handTracker;
        let game;
        let videoElement;
        let canvasElement;

        async function init() {
            try {
                videoElement = document.getElementById('input_video');
                canvasElement = document.getElementById('output_canvas');
                
                // CONFIGURA√á√ÉO RESPONSIVA DO CANVAS
                const updateCanvasSize = () => {
                    canvasElement.width = window.innerWidth;
                    canvasElement.height = window.innerHeight;
                    if (game) {
                        game.renderer.setSize(window.innerWidth, window.innerHeight);
                    }
                };
                
                updateCanvasSize();
                
                game = new LabirintoEletrico();
                handTracker = new HandTracker();
                
                await handTracker.initialize(videoElement, canvasElement, onResults);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                
                document.getElementById('next-level').addEventListener('click', () => {
                    game.nextLevel();
                });
                
                document.getElementById('restart').addEventListener('click', () => {
                    game.restart();
                });
                
                // OTIMIZA√á√ÉO DE PERFORMANCE PARA MOBILE
                if (isMobile) {
                    // REDUZIR FPS NO MOBILE
                    let lastTime = 0;
                    const targetFPS = 30;
                    const interval = 1000 / targetFPS;
                    
                    function animateMobile(currentTime) {
                        requestAnimationFrame(animateMobile);
                        
                        if (currentTime - lastTime >= interval) {
                            game.render();
                            lastTime = currentTime;
                        }
                    }
                    animateMobile();
                } else {
                    animate();
                }
                
                // LISTENER DE REDIMENSIONAMENTO
                window.addEventListener('resize', updateCanvasSize);
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                document.getElementById('loading').innerHTML = 
                    '<h2>‚ùå Ops!</h2><p>Erro na c√¢mera</p><p>Verifique permiss√µes!</p>';
            }
        }

        function onResults(results) {
            const canvasCtx = canvasElement.getContext('2d');
            
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.restore();
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const fingerTip = handTracker.getIndexFingerTip(landmarks);
                
                if (fingerTip) {
                    const x = fingerTip.x;
                    const y = fingerTip.y;
                    
                    game.updateHandPosition(x, y);
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            game.render();
        }

        // PREVENIR ZOOM NO MOBILE
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gesturechange', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gestureend', function (e) {
            e.preventDefault();
        });

        // INICIALIZAR QUANDO CARREGAR
        window.addEventListener('load', init);

        // OTIMIZA√á√ÉO DE PERFORMANCE - PAUSAR QUANDO SAIR DA ABA
        document.addEventListener('visibilitychange', function() {
            if (game && game.audioManager) {
                if (document.hidden) {
                    game.audioManager.stopBackgroundMusic();
                } else {
                    game.audioManager.playBackgroundMusic();
                }
            }
        });
    </script>
</body>
</html>